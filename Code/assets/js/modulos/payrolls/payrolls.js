import{msgError,msgSuccess}from"../message.js";import{liMostrar,TableAndpagination,pagina}from"../pagination.js";if("?c=Nominas&m=index"==location.search){let e=[],t=[];document.getElementById("CancelarNomina"),document.getElementById("cerrarModalNomina");const a=document.getElementById("lista_concepto"),n=document.getElementById("show_lista_concepto"),o=document.getElementById("update_lista_concepto"),c=document.getElementById("guardarArray"),i=document.getElementById("guardarArrayUpdate"),r=document.getElementById("tablaAllNominas");let d=[];const l=()=>{e=[],a.innerHTML=""},s=(e,t,a)=>{if(""==e.value){e.focus(),msgError("Ingresar la descripcion del concepto")}else if(""==t.value){t.focus(),msgError("Ingresar el Asiento Contable")}else{if(""!=a.value)return!0;a.focus(),msgError("Ingresar el valor del concepto ")}},m=(e,t,a)=>{const n=document.createDocumentFragment(),o=document.createElement("TR");o.classList.add("table-light");const c=document.createElement("TD");c.textContent=`${t}`,o.append(c);const i=document.createElement("TD");i.textContent=`${e.descripcion}`,i.classList.add("text-capitalize"),o.append(i);const r=document.createElement("TD");r.textContent=`${e.asiento_contable}`,o.append(r);const d=document.createElement("TD");d.textContent=`${e.tipo_concepto}`,o.append(d);const l=document.createElement("TD");if(l.textContent=`${e.valor}`,o.append(l),"update"==a||"crear"==a){const t=document.createElement("TD");t.classList.add("i-separated");const a=document.createElement("I");a.setAttribute("data-target","BorrarConcepto"),a.setAttribute("data-id",`${e.id_concepto}`),a.classList.add("delete-svg"),t.append(a),o.append(t)}return n.append(o),n},u=(e,t="crear")=>{const c=document.createDocumentFragment();let i=0;for(const a of e)i++,c.append(m(a,i,t));"update"==t?(document.getElementById("update_fecha_de").value=`${e[0].fecha_de}`,document.getElementById("update_fecha_hasta").value=e[0].fecha_hasta,o.innerHTML="",o.appendChild(c)):"show"==t?(n.innerHTML="",n.append(c)):"crear"==t&&(a.innerHTML="",a.append(c))};c.addEventListener("click",t=>{t.preventDefault();const a=e.length,n=document.getElementById("descripcion_nomina"),o=document.getElementById("contable"),c=document.getElementById("valor"),i=document.getElementById("tipo_concepto");if(s(n,o,c,i)){let t={id_concepto:a,descripcion:n.value,asiento_contable:o[o.value].textContent,fk_asiento_contable:o.value,valor:c.value,tipo_concepto:i[i.value].textContent,fk_tipo_concepto:i.value};e.push(t),u(e),n.value="",o.value="",c.value=""}}),i.addEventListener("click",e=>{e.preventDefault();const a=document.getElementById("update_descripcion_nomina"),n=document.getElementById("update_contable"),o=document.getElementById("update_valor"),c=document.getElementById("update_tipo_concepto"),i=document.getElementById("update_nomina");if(s(a,n,o,c)){let e={id_concepto:t.length,descripcion:a.value,fk_asiento_contable:n.value,tipo_concepto:c[c.value].textContent,asiento_contable:n[n.value].textContent,valor:o.value,fk_tipo_concepto:c.value,fk_nomina:i.value};t.push(e),u(t,"update"),a.value="",n.value="",o.value=""}}),a.addEventListener("click",t=>{if(t.preventDefault(),t.target.getAttribute("data-id")){let a=t.target.getAttribute("data-id");const n=e.filter(e=>e.id_concepto==a)[0],o=`${n.descripcion} con el valor ${n.valor}`;p(o,a,"crear")}}),o.addEventListener("click",e=>{if(e.preventDefault(),e.target.getAttribute("data-id")){let a=e.target.getAttribute("data-id");const n=t.filter(e=>e.id_concepto==a)[0],o=`${n.descripcion} con el valor ${n.valor}`;p(o,a)}});const p=(a,n,o="actualizar")=>{Swal.fire({icon:"warning",html:`<p class="text-white h4 mb-3 text-capitalize">Desea borrar el concepto</p><p class="text-danger text-capitalize h6">${a}</p>`,focusConfirm:!0,background:"#343a40",confirmButtonText:"Entendido",confirmButtonColor:"#6C63FF",showCancelButton:!0,cancelButtonText:"Cancelar",cancelButtonColor:"#6C63FF"}).then(a=>{if(a.value)if("crear"!=o){const e=t.filter(e=>e.id_concepto!=n);u(t=e,"update")}else{const t=e.filter(e=>e.id_concepto!=n);u(e=t)}})};document.getElementById("GuardarNomina").addEventListener("click",function(t){t.preventDefault();const a=document.getElementById("usuario"),n=document.getElementById("fecha_de"),o=document.getElementById("fecha_hasta"),c=JSON.stringify(e);if(_(a,n,o,c)){const e=new FormData;e.append("fk_usuario",a.value),e.append("fecha_de",n.value),e.append("fecha_hasta",o.value),e.append("arrayDatos",c),fetch("?c=Nominas&m=store",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Error al Crear Nomina"))).then(e=>e.json()).then(e=>{if(e.ok){$("#ModalAddNomina").modal("hide"),msgSuccess("La Nomina se ha creado"),l(),a.value="",n.value="",o.value="",E()}else{if("Ya existe una nomina de ese mes"==e.error){const t=e.error;return void msgError(t)}msgError("Error Fallo"),setTimeout(()=>{location="?c=All&m=index"},1500)}})}});const g=(e,t)=>{const a=document.createDocumentFragment(),n=document.createElement("TR");n.classList.add("table-light");const o=document.createElement("TD");o.setAttribute("colspan","1"),o.textContent=`${t}`,n.append(o);const c=document.createElement("TD");c.setAttribute("colspan","2"),c.classList.add("text-capitalize"),c.textContent=`${e.numero_documento}`,n.append(c);const i=document.createElement("TD");i.setAttribute("colspan","2"),i.classList.add("text-capitalize"),i.textContent=`${e.nombres} ${e.apellidos}`,n.append(i);const r=document.createElement("TD");r.textContent=`${e.valor}`,n.append(r);const d=document.createElement("TD");d.textContent=`${e.fecha_de}`,n.append(d);const l=document.createElement("TD");l.classList.add("text-capitalize"),l.textContent=`${e.fecha_hasta}`,n.append(l);const s=document.createElement("TD");s.classList.add("i-separated");let m=document.createElement("I");if(m.id=`${e.id_nomina}`,m.setAttribute("data-toggle","modal"),m.setAttribute("data-target","#ModalShowNomina"),m.classList.add("show-svg"),s.append(m),Date.parse(e.fecha_hasta)>Date.now()){let t=document.createElement("I");t.id=`${e.id_nomina}`,t.classList.add("edit-svg"),t.setAttribute("data-toggle","modal"),t.setAttribute("data-target","#ModalUpdateNomina"),s.append(t)}let u=document.createElement("A");return u.id=`${e.id_nomina}`,u.classList.add("pdf-svg"),u.setAttribute("href",`?c=Pdf&m=downloadpdf&id_nomina=${e.id_nomina}`),u.setAttribute("target","_blank"),s.append(u),n.append(s),a.append(n),a};liMostrar.addEventListener("click",function(e){if("button"==e.target.localName)if("Siguiente"!=e.target.textContent&&"Anterior"!=e.target.textContent){let t=e.target.textContent;pagina.pagina=Number(t),TableAndpagination(pagina.pagina,pagina.usuariosFila,d,f)}else if("Siguiente"==e.target.textContent){let e=Math.ceil(d.length/pagina.usuariosFila);pagina.pagina<e&&(pagina.pagina+=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,d,f))}else"Anterior"==e.target.textContent&&pagina.pagina>1&&(pagina.pagina-=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,d,f))});const f=e=>{const t=document.createDocumentFragment();let a=0;for(const n of e)a++,t.append(g(n,a));r.innerHTML="",r.append(t)},h=document.getElementById("buscador");h.addEventListener("input",function(e){let t=h.value.toLowerCase();if(r.innerHTML="",""!=t.trim()){let e=1;for(const a of d){-1!=`${a.numero_documento}`.indexOf(t)&&r.appendChild(g(a,e++))}}""==t.trim()&&TableAndpagination(pagina.pagina,pagina.usuariosFila,d,f)});const E=()=>{fetch("?c=Nominas&m=allNominasJson").then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallos la consulta"))).then(e=>e.json()).then(e=>{d=e,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,f)}).catch(e=>console.log(e))};r.addEventListener("click",e=>{const t=e.target;if(t.getAttribute("id")){const e=t.getAttribute("id"),a=d.filter(t=>t.id_nomina==e)[0];"#ModalUpdateNomina"==t.getAttribute("data-target")?(document.getElementById("update_nomina").value=a.id_nomina,b(a.id_nomina,"update")):"#ModalShowNomina"==t.getAttribute("data-target")&&(v(a),b(a.id_nomina,"show"))}});const _=(e,t,a,n)=>{if(""==e.value){e.focus(),msgError("Ingresar el usuario de la nomina")}else if(""==t.value){t.focus(),msgError("Ingresar la fecha de inicio de la nomina")}else if(""==a.value){a.focus(),msgError("Ingresar la fecha hasta de la nomina ")}else{if(2!=n.length)return!0;msgError("Ingresar los Conceptos de la Nomina ")}},v=e=>{document.getElementById("show_user").textContent=`${e.nombres} ${e.apellidos}`,document.getElementById("show_salario").textContent=`${e.valor}`,document.getElementById("show_fecha_de").textContent=`${e.fecha_de}`,document.getElementById("show_fecha_hasta").textContent=`${e.fecha_hasta}`},b=(e,a)=>{fetch(`?c=Nominas&m=showConceptsID&id=${e}`).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallos la consulta"))).then(e=>e.json()).then(e=>{t=[],u(t=e,a)}).catch(e=>console.log(e))};document.getElementById("UpdateNomina").addEventListener("click",e=>{e.preventDefault();const a=document.getElementById("update_nomina"),n=document.getElementById("update_fecha_de"),o=document.getElementById("update_fecha_hasta"),c=JSON.stringify(t);if(_(a,n,o,c)){const e=new FormData;e.append("fk_nomina",a.value),e.append("update_fecha_de",n.value),e.append("update_fecha_hasta",o.value),e.append("arrayDatos",c),fetch("?c=Nominas&m=update",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Error al Crear Nomina"))).then(e=>e.json()).then(e=>{if(e.ok){$("#ModalUpdateNomina").modal("hide"),msgSuccess("La Nomina se ha Actualizado"),t=[],n.value="",o.value="",E()}else{if("Ya existe una nomina de ese mes"==e.error){const t=e.error;return void msgError(t)}msgError("Error Fallo"),setTimeout(()=>{location="?c=All&m=index"},1500)}})}}),E()}