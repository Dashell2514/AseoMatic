//! JS Modulo Administrar Eventos
import { msgError,msgSuccess } from "../message.js";import {  liMostrar, TableAndpagination, pagina} from "../pagination.js";import { toolbarOptions } from "../main.js";if("?c=Eventos&m=showEvents"==location.search){let e=[];const t=document.getElementById("tablaAllEvents"),n=(e,t)=>{const n=document.createDocumentFragment(),a=document.createElement("TR");a.classList.add("table-light");const o=document.createElement("TD");o.setAttribute("colspan","1"),o.textContent=`${t}`,a.append(o);const i=document.createElement("TD");i.setAttribute("colspan","2"),i.textContent=`${e.titulo_evento}`,i.classList.add("text-capitalize"),a.append(i);const l=document.createElement("TD");l.setAttribute("colspan","2"),l.textContent=`${e.fecha_publicado}`,a.append(l);const d=document.createElement("TD");d.textContent=`${e.nombres} ${e.apellidos}`,d.classList.add("text-capitalize"),a.append(d);const r=document.createElement("TD");r.classList.add("i-separated");let s=document.createElement("I");s.id=`${e.id_evento}`,s.setAttribute("data-toggle","modal"),s.setAttribute("data-target","#ModalShowEvents"),s.classList.add("show-svg"),r.append(s);let c=document.createElement("I");c.id=`${e.id_evento}`,c.classList.add("edit-svg"),c.setAttribute("data-toggle","modal"),c.setAttribute("data-target","#ModalUpdateEvents"),r.append(c);let u=document.createElement("I");return u.id=`${e.id_evento}`,u.classList.add("delete-svg"),u.setAttribute("data-target","#ModalDeleteEvents"),r.append(u),a.append(r),n.append(a),n},a=e=>{const a=document.createDocumentFragment();let o=0;for(const t of e)o++,a.append(n(t,o));t.innerHTML="",t.append(a)};liMostrar.addEventListener("click",function(t){if("button"==t.target.localName)if("Siguiente"!=t.target.textContent&&"Anterior"!=t.target.textContent){let n=t.target.textContent;pagina.pagina=Number(n),TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a)}else if("Siguiente"==t.target.textContent){let t=Math.ceil(e.length/pagina.usuariosFila);pagina.pagina<t&&(pagina.pagina+=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a))}else"Anterior"==t.target.textContent&&pagina.pagina>1&&(pagina.pagina-=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a))});const o=()=>{fetch("?c=Eventos&m=allEventsJson").then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallos la consulta"))).then(e=>e.json()).then(t=>{e=t,TableAndpagination(pagina.pagina,pagina.usuariosFila,t,a)}).catch(e=>console.log(e))},i=e=>{document.getElementById("update_titulo_evento").value=`${e.titulo_evento}`,quillEventUpdate.clipboard.dangerouslyPasteHTML(`${e.descripcion_evento}`),document.getElementById("update_fk_usuario").value=`${e.fk_usuario}`,document.getElementById("update_prev-img").src=`${e.imagen_evento}`,document.getElementById("update_id_evento").value=`${e.id_evento}`},l=e=>{document.getElementById("show_titulo_evento").textContent=`${e.titulo_evento}`,document.getElementById("show_descripcion_evento").innerHTML=`${e.descripcion_evento}`,document.getElementById("show_fecha_evento").textContent=`${e.nombres} ${e.apellidos} ${e.fecha_publicado}`,document.getElementById("show_prev_img").src=`${e.imagen_evento}`},d=document.getElementById("buscador");d.addEventListener("input",function(o){let i=d.value.toLowerCase();if(t.innerHTML="",""!=i.trim()){let a=1;for(const o of e){-1!=`${o.titulo_evento}`.indexOf(i)&&t.appendChild(n(o,a++))}}""==i.trim()&&TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a)});const r=(e,t,n,a)=>{if(""==e.value){const t="Ingrese el titulo del Evento";e.focus(),msgError(t)}else if(t.getLength()-1==""){const e="Ingrese la descripcion del Evento";t.focus(),msgError(e)}else if(""==n.value){const e="Ingrese el autor del Evento";n.focus(),msgError(e)}else{if(""!=a.src&&"image not found"!=a.alt)return!0;{const e="Ingrese la imagen del Evento";a.focus(),msgError(e)}}},s=(e,t,n,a,o)=>{document.getElementById(e).value="",t.container.firstChild.innerHTML="",document.getElementById(n).value="",document.getElementById(a).value="",document.getElementById(o).src=""},c=document.getElementById("event_img"),u=document.getElementById("prev-img"),m=document.getElementById("update_event_img"),g=document.getElementById("update_prev-img"),p=(e,t)=>{const n=e.files[0];if("image/jpeg"!=n.type&&"image/png"!=n.type&&"image/jpeg"!=n.type){return e.value="",msgError("la imagen debe ser png o jpeg"),t.src="",t.alt="image not found",!1}if(n.size>2e6){return e.value="",msgError("la imagen debe ser menor a 2mb"),t.src="",t.alt="image not found",!1}{t.src="";const e=new FileReader;return e.readAsDataURL(n),e.addEventListener("load",e=>{t.src=e.target.result}),!0}};c.addEventListener("change",()=>{p(c,u)}),m.addEventListener("change",()=>{p(m,g)}),t.addEventListener("click",t=>{const n=t.target;if(n.getAttribute("id")){const t=n.getAttribute("id"),a=e.filter(e=>e.id_evento==t)[0];if("#ModalUpdateEvents"==n.getAttribute("data-target"))i(a);else if("#ModalDeleteEvents"==n.getAttribute("data-target")){const e=`${a.titulo_evento} del autor ${a.nombres} ${a.apellidos}`;_(e,a.id_evento)}else"#ModalShowEvents"==n.getAttribute("data-target")&&l(a)}}),document.getElementById("GuardarEvento").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("titulo_evento"),n=quillEvent,a=document.getElementById("fk_usuario"),i=c.files[0];if(!0===r(t,n,a,u)){const e=new FormData;e.append("titulo_evento",t.value.toLowerCase()),e.append("descripcion_evento",n.container.firstChild.innerHTML),e.append("event_img",i),e.append("fk_usuario",a.value),fetch("?c=Eventos&m=storeEvents",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallo la insercion"))).then(e=>e.json()).then(e=>{if(e.ok){$("#ModalAddEvents").modal("hide"),s("titulo_evento",n,"fk_usuario","event_img","prev-img"),msgSuccess("Evento Agregada Correctamente"),o()}else{msgError("Error ha modificado el html"),setTimeout(()=>{location="?c=All&m=index"},1500)}}).catch(console.log)}});const v=document.getElementById("CancelarEvento"),E=document.getElementById("cerrarModalNoticia");v.addEventListener("click",()=>{s("titulo_evento",quillEvent,"fk_usuario","event_img","prev-img")}),E.addEventListener("click",()=>{s("titulo_evento",quillEvent,"fk_usuario","event_img","prev-img")}),document.getElementById("ActualizarEvento").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("update_titulo_evento"),n=quillEventUpdate,a=document.getElementById("update_fk_usuario"),i=document.getElementById("update_id_evento"),l=m.files[0];if(1==r(t,n,a,g)){const e=new FormData;e.append("update_id_evento",i.value),e.append("update_titulo_evento",t.value.toLowerCase()),e.append("update_descripcion_evento",n.container.firstChild.innerHTML),e.append("update_fk_usuario",a.value),e.append("update_event_img",l),fetch("?c=Eventos&m=updateEvents",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Error al actualizar noticia"))).then(e=>e.json()).then(e=>{if(e.ok){$("#ModalUpdateEvents").modal("hide"),msgSuccess("El Evento se ha actualizado correctamente"),o()}else{msgError("Error ha modificado el html"),setTimeout(()=>{location="?c=All&m=index"},1500)}})}});const _=(e,t)=>{Swal.fire({icon:"warning",html:`<p class="text-white h4 mb-3 text-capitalize">Desea borrar el Evento</p><p class="text-danger text-capitalize h6">${e}</p>`,focusConfirm:!0,background:"#343a40",confirmButtonText:"Entendido",confirmButtonColor:"#6C63FF",showCancelButton:!0,cancelButtonText:"Cancelar",cancelButtonColor:"#6C63FF"}).then(e=>{if(e.value){msgSuccess("El Evento ha sido eliminado"),f(t)}})},f=e=>{fetch(`?c=Eventos&m=destroyEvents&id=${e}`,{}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("fallo el delete"))).then(e=>e.text()).then(e=>{o()}).catch(console.log)};o();var quillEvent=new Quill("#descripcion_evento",{modules:{toolbar:toolbarOptions},theme:"snow"}),quillEventUpdate=new Quill("#update_descripcion_evento",{modules:{toolbar:toolbarOptions},theme:"snow"})}
//! End JS Modulo Administrar Eventos