//! JS Modulo Administrar Usuarios
import { msgError,msgSuccess } from "../message.js";import { validateEmail,validateName,validatePasswordModerate,validateDocumentNumber} from "../validation.js";import {  liMostrar, TableAndpagination, pagina} from "../pagination.js";if("?c=Usuarios&m=show"==location.search){let e=[];const t=document.getElementById("tablaAllUser");t.addEventListener("click",t=>{const o=t.target;if(o.getAttribute("id")){const t=o.getAttribute("id"),a=e.filter(e=>e.id_usuario==t)[0];if("#ModalUpdateUser"==o.getAttribute("data-target"))d(a),U(a.id_usuario,"update");else if("#Delete"==o.getAttribute("data-target")){const e=`${a.nombres} ${a.apellidos} identificado con el documento ${a.numero_documento}`;y(e,a.id_usuario,a.token,a.estado)}else"#ModalShowUser"==o.getAttribute("data-target")&&(l(a),U(a.id_usuario,"show"))}});const o=(e,t)=>{const o=document.createDocumentFragment(),a=document.createElement("TR");a.classList.add("table-light");const n=document.createElement("TD");n.setAttribute("colspan","1"),n.textContent=`${t}`,a.append(n);const r=document.createElement("TD");r.setAttribute("colspan","2"),r.classList.add("text-capitalize"),r.textContent=`${e.nombres}`,a.append(r);const d=document.createElement("TD");d.setAttribute("colspan","2"),d.classList.add("text-capitalize"),d.textContent=`${e.apellidos}`,a.append(d);const l=document.createElement("TD");l.textContent=`${e.numero_documento}`,a.append(l);const c=document.createElement("TD");c.textContent=`${e.correo}`,a.append(c);const u=document.createElement("TD");u.classList.add("text-capitalize"),u.textContent=`${e.nombre_rol}`,a.append(u);const i=document.createElement("TD");i.classList.add("i-separated");let s=document.createElement("I");s.id=`${e.id_usuario}`,s.setAttribute("data-toggle","modal"),s.setAttribute("data-target","#ModalShowUser"),s.classList.add("show-svg"),i.append(s);let m=document.createElement("I");m.id=`${e.id_usuario}`,m.classList.add("edit-svg"),m.setAttribute("data-toggle","modal"),m.setAttribute("data-target","#ModalUpdateUser"),i.append(m);let p=document.createElement("I");return p.id=`${e.id_usuario}`,1==e.estado?p.classList.add("enable-svg"):p.classList.add("disable-svg"),p.setAttribute("data-toggle","modal"),p.setAttribute("data-target","#Delete"),i.append(p),a.append(i),o.append(a),o};liMostrar.addEventListener("click",function(t){if("button"==t.target.localName)if("Siguiente"!=t.target.textContent&&"Anterior"!=t.target.textContent){let o=t.target.textContent;pagina.pagina=Number(o),TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a)}else if("Siguiente"==t.target.textContent){let t=Math.ceil(e.length/pagina.usuariosFila);pagina.pagina<t&&(pagina.pagina+=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a))}else"Anterior"==t.target.textContent&&pagina.pagina>1&&(pagina.pagina-=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a))});const a=e=>{const a=document.createDocumentFragment();let n=0;for(const t of e)n++,a.append(o(t,n));t.innerHTML="",t.append(a)},n=document.getElementById("buscador");n.addEventListener("input",function(r){let d=n.value.toLowerCase();if(t.innerHTML="",""!=d.trim()){let a=1;for(const n of e){let e=`${n.nombres} ${n.apellidos}`,r=`${n.numero_documento}`;-1==e.indexOf(d)&&-1==r.indexOf(d)||t.appendChild(o(n,a++))}}""==d.trim()&&TableAndpagination(pagina.pagina,pagina.usuariosFila,e,a)});const r=()=>{fetch("?c=Usuarios&m=allUsersJson").then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallos la consulta"))).then(e=>e.json()).then(t=>{e=t,TableAndpagination(pagina.pagina,pagina.usuariosFila,t,a)}).catch(e=>console.log(e))},d=e=>{document.getElementById("update_nombres").value=`${e.nombres}`,document.getElementById("update_apellidos").value=`${e.apellidos}`,document.getElementById("update_correo").value=`${e.correo}`,document.getElementById("update_rol").value=`${e.fk_rol}`,document.getElementById("update_clave").value="",document.getElementById("update_tipo_documento").value=`${e.fk_tipo_documento}`,document.getElementById("update_numero_documento").value=`${e.numero_documento}`,document.getElementById("update_salario").value=`${e.salario}`,document.getElementById("update_cargo").value=`${e.fk_cargo}`,document.getElementById("update_tipo_contrato").value=`${e.fk_tipo_contrato}`,document.getElementById("update_id").value=`${e.id_usuario}`,document.getElementById("token").value=`${e.token}`,document.getElementById("clave_antigua").value=`${e.clave}`,document.getElementById("update_prev_user_img").src=`${e.img_usuario}`},l=e=>{document.getElementById("show_nombres").textContent=`${e.nombres} ${e.apellidos}`,document.getElementById("show_correo").textContent=`${e.correo}`,document.getElementById("show_rol").value=`${e.fk_rol}`,document.getElementById("show_tipo_documento").value=`${e.fk_tipo_documento}`,document.getElementById("show_numero_documento").textContent=`${e.numero_documento}`,document.getElementById("show_cargo").value=`${e.fk_cargo}`,document.getElementById("show_salario").textContent=`${e.salario}`,document.getElementById("show_tipo_contrato").value=`${e.fk_tipo_contrato}`,document.getElementById("show_user_img").src=`${e.img_usuario}`},c={nombre:!1,apellido:!1,correo:!1,clave:!1,numeroDocumento:!1,fkRol:!1,tipoContrato:!1,cargo:!1,tipoDocumento:!1},u=()=>{c.nombre=!1,c.apellido=!1,c.correo=!1,c.clave=!1,c.numeroDocumento=!1,c.fkRol=!1,c.tipoContrato=!1,c.cargo=!1,c.tipoDocumento=!1},i=()=>{document.getElementById("nombres").value="",document.getElementById("apellidos").value="",document.getElementById("correo").value="",document.getElementById("clave").value="",document.getElementById("tipo_documento").value="",document.getElementById("numero_documento").value="",document.getElementById("cargo").value="",document.getElementById("tipo_contrato").value="",document.getElementById("rol").value="",document.getElementById("prev_user_img").src="",document.getElementById("user_img").value=""},s=()=>{return-1==Object.values(c).findIndex(e=>0==e)},m=(e,t,o,a,n,r,d,l)=>{if(""==e.value){e.focus(),msgError("Ingresar nombres del usuario")}else if(0==validateName(e.value)){e.focus(),msgError("El nombre ingresado no es valido")}else if(""==t.value){t.focus(),msgError("Ingresar apellidos del usuario")}else if(0==validateName(t.value)){t.focus(),msgError("El apellido ingresado no es valido")}else if(""==o.value){o.focus(),msgError("Ingresar correo del usuario")}else if(0==validateEmail(o.value)){o.focus(),msgError("El Correo Ingresado No es Valido")}else if(""==a.value){a.focus(),msgError("Ingresar numero documento")}else if(1!=validateDocumentNumber(a.value)){a.focus(),msgError("Numero documento no valido")}else if(""==l.value){l.focus(),msgError("Seleccionar el tipo de documento")}else if(""==d.value){d.focus(),msgError("Seleccionar el cargo")}else if(""==r.value){r.focus(),msgError("Seleccionar el Tipo de Contrato")}else{if(""!=n.value)return c.nombre=!0,c.apellido=!0,c.correo=!0,c.numeroDocumento=!0,c.fkRol=!0,c.tipoContrato=!0,c.cargo=!0,c.tipoDocumento=!0,!0;n.focus(),msgError("Seleccionar el tipo de Rol")}},p=e=>{if(""==e.value){e.focus(),msgError("Ingresar clave del usuario")}else{if(0!=validatePasswordModerate(e.value))return c.clave=!0,!0;e.focus(),msgError("Clave no valida Debe tener 1 letra minúscula, 1 letra mayúscula, 1 número y tener al menos 8 caracteres.")}},g=document.getElementById("user_img"),v=document.getElementById("prev_user_img"),_=document.getElementById("update_user_img"),E=document.getElementById("update_prev_user_img"),f=(e,t)=>{const o=e.files[0];if("image/jpeg"!=o.type&&"image/png"!=o.type&&"image/jpeg"!=o.type){return e.value="",msgError("la imagen debe ser png o jpeg"),t.src="",t.alt="image not found",!1}if(o.size>2e6){return e.value="",msgError("la imagen debe ser menor a 2mb"),t.src="",t.alt="image not found",!1}{t.src="";const e=new FileReader;return e.readAsDataURL(o),e.addEventListener("load",e=>{t.src=e.target.result}),!0}};g.addEventListener("change",()=>{f(g,v)}),_.addEventListener("change",()=>{f(_,E)});const I=e=>{if(2!=e.length)return!0;msgError("Ingresar los Conceptos")};document.getElementById("GuardarUsuario").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("nombres"),o=document.getElementById("apellidos"),a=document.getElementById("correo"),n=document.getElementById("tipo_documento"),d=document.getElementById("clave"),l=document.getElementById("numero_documento"),c=document.getElementById("cargo"),v=document.getElementById("tipo_contrato"),_=(document.getElementById("fondo_pension"),document.getElementById("rol")),E=document.getElementById("salario"),f=g.files[0],y=document.getElementById("fecha_de"),B=document.getElementById("fecha_hasta"),b=JSON.stringify(h);if(1==m(t,o,a,l,_,v,c,n)&&1==I(b)){if(1==p(d)&&1==s()){const e=new FormData;e.append("nombres",t.value.toLowerCase()),e.append("apellidos",o.value.toLowerCase()),e.append("correo",a.value.toLowerCase()),e.append("clave",d.value),e.append("tipo_documento",n.value),e.append("numero_documento",l.value),e.append("rol",_.value),e.append("cargo",c.value),e.append("fk_tipo_contrato",v.value),e.append("salario",E.value),e.append("user_img",f),e.append("fecha_de",y.value),e.append("fecha_hasta",B.value),e.append("arrayDatos",b),fetch("?c=Usuarios&m=store",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("fallo la insercion"))).then(e=>e.json()).then(e=>{if("correoExistente"==e.error){a.focus(),msgError("Ya hay otra persona que tiene esta dirección de correo electrónico.")}else if("errorAgregarUsuario"==e.error){msgError("Fallo la creacion de usuario")}else if(e.ok){$("#ModalAddUser").modal("hide"),msgSuccess("Usuario Agregado Correctamente"),r(),u(),i()}}).catch(e=>console.log(e))}}}),document.getElementById("CancelarUsuario").addEventListener("click",()=>{i()}),document.getElementById("EditarUsuario").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("update_nombres"),o=document.getElementById("update_apellidos"),a=document.getElementById("update_correo"),n=document.getElementById("update_clave"),d=document.getElementById("update_tipo_documento"),l=document.getElementById("update_numero_documento"),i=document.getElementById("update_salario"),g=document.getElementById("update_cargo"),v=document.getElementById("update_tipo_contrato"),E=document.getElementById("update_rol"),f=document.getElementById("updated_at"),I=document.getElementById("update_id"),y=document.getElementById("token"),B=document.getElementById("clave_antigua"),h=_.files[0],C=document.getElementById("update_nomina"),x=JSON.stringify(b);let D=m(t,o,a,l,E,v,g,d);if(""==n.value?c.clave=!0:p(n),1==D&&1==s()){const e=new FormData;e.append("update_id",I.value),e.append("update_nombres",t.value.toLowerCase()),e.append("update_apellidos",o.value.toLowerCase()),e.append("update_correo",a.value.toLowerCase()),e.append("update_clave",n.value),e.append("update_tipo_documento",d.value),e.append("update_numero_documento",l.value),e.append("update_cargo",g.value),e.append("update_tipo_contrato",v.value),e.append("update_rol",E.value),e.append("update_salario",i.value),e.append("updated_at",f.value),e.append("token",y.value),e.append("clave_antigua",B.value),e.append("update_user_img",h),e.append("fk_nomina",C.value),e.append("arrayDatos",x),fetch("?c=Usuarios&m=update",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("fallo la actualizacion"))).then(e=>e.json()).then(e=>{if("correoExistente"==e.error){correo.focus(),msgError("Ya hay otra persona que tiene esta dirección de correo electrónico.")}else if(e.error){msgError("Fallo la actualizacion del usuario")}else if(e.ok){$("#ModalUpdateUser").modal("hide"),msgSuccess("Usuario Actualizado Correctamente"),r(),u()}}).catch(console.log)}});const y=(e,t,o,a)=>{Swal.fire({icon:"warning",html:`<p class="text-white h4 mb-3 text-capitalize">${1==a?"Desea Deshabilitar al usuario":"Desea Hablitar al usuario"}</p><p class="text-danger text-capitalize h6">${e}</p>`,focusConfirm:!0,background:"#343a40",confirmButtonText:"Entendido",confirmButtonColor:"#6C63FF",showCancelButton:!0,cancelButtonText:"Cancelar",cancelButtonColor:"#6C63FF"}).then(e=>{if(e.value)if(1==a){msgSuccess("El usuario ha sido deshabilitado"),B(t,o,2)}else{msgSuccess("El usuario ha sido Habilitado"),B(t,o,1)}})},B=(e,t,o)=>{fetch(`?c=Usuarios&m=disable&delete_id=${e}&token=${t}&option=${o}`,{}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("fallo la deshabilitacion de usuario"))).then(e=>e.text()).then(e=>{r()})};r();let h=[],b=[];const C=document.getElementById("lista_concepto"),x=document.getElementById("show_lista_concepto"),D=document.getElementById("update_lista_concepto"),k=document.getElementById("guardarArray"),w=document.getElementById("guardarArrayUpdate"),L=(e,t,o)=>{if(""==e.value){e.focus(),msgError("Ingresar la descripcion del concepto")}else if(""==t.value){t.focus(),msgError("Ingresar el Asiento Contable")}else{if(""!=o.value)return!0;o.focus(),msgError("Ingresar el valor del concepto ")}},A=(e,t,o)=>{const a=document.createDocumentFragment(),n=document.createElement("TR");n.classList.add("table-light");const r=document.createElement("TD");r.textContent=`${t}`,n.append(r);const d=document.createElement("TD");d.textContent=`${e.descripcion}`,d.classList.add("text-capitalize"),n.append(d);const l=document.createElement("TD");l.textContent=`${e.asiento_contable}`,n.append(l);const c=document.createElement("TD");c.textContent=`${e.tipo_concepto}`,n.append(c);const u=document.createElement("TD");if(u.textContent=`${e.valor}`,n.append(u),"update"==o||"crear"==o){const t=document.createElement("TD");t.classList.add("i-separated");const o=document.createElement("I");o.setAttribute("data-target","BorrarConcepto"),o.setAttribute("data-id",`${e.id_concepto}`),o.classList.add("delete-svg"),t.append(o),n.append(t)}return a.append(n),a},T=(e,t="crear")=>{const o=document.createDocumentFragment();let a=0;for(const n of e)a++,o.append(A(n,a,t));"update"==t?(D.innerHTML="",D.appendChild(o)):"show"==t?(x.innerHTML="",x.append(o)):"crear"==t&&(C.innerHTML="",C.append(o))};k.addEventListener("click",e=>{e.preventDefault();const t=h.length,o=document.getElementById("descripcion_nomina"),a=document.getElementById("contable"),n=document.getElementById("valor"),r=document.getElementById("tipo_concepto");if(L(o,a,n,r)){let e={id_concepto:t,descripcion:o.value,asiento_contable:a[a.value].textContent,fk_asiento_contable:a.value,valor:n.value,tipo_concepto:r[r.value].textContent,fk_tipo_concepto:r.value};h.push(e),T(h),o.value="",a.value="",n.value=""}}),w.addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("update_descripcion_nomina"),o=document.getElementById("update_contable"),a=document.getElementById("update_valor"),n=document.getElementById("update_tipo_concepto"),r=document.getElementById("update_nomina");if(L(t,o,a,n)){let e={id_concepto:b.length,descripcion:t.value,fk_asiento_contable:o.value,tipo_concepto:n[n.value].textContent,asiento_contable:o[o.value].textContent,valor:a.value,fk_tipo_concepto:n.value,fk_nomina:r.value};b.push(e),T(b,"update"),t.value="",o.value="",a.value=""}}),C.addEventListener("click",e=>{if(e.preventDefault(),e.target.getAttribute("data-id")){let t=e.target.getAttribute("data-id");const o=h.filter(e=>e.id_concepto==t)[0],a=`${o.descripcion} con el valor ${o.valor}`;F(a,t,"crear")}}),D.addEventListener("click",e=>{if(e.preventDefault(),e.target.getAttribute("data-id")){let t=e.target.getAttribute("data-id");const o=b.filter(e=>e.id_concepto==t)[0],a=`${o.descripcion} con el valor ${o.valor}`;F(a,t)}});const F=(e,t,o="actualizar")=>{Swal.fire({icon:"warning",html:`<p class="text-white h4 mb-3 text-capitalize">Desea borrar el concepto</p><p class="text-danger text-capitalize h6">${e}</p>`,focusConfirm:!0,background:"#343a40",confirmButtonText:"Entendido",confirmButtonColor:"#6C63FF",showCancelButton:!0,cancelButtonText:"Cancelar",cancelButtonColor:"#6C63FF"}).then(e=>{if(e.value)if("crear"!=o){const e=b.filter(e=>e.id_concepto!=t);T(b=e,"update")}else{const e=h.filter(e=>e.id_concepto!=t);T(h=e)}})},U=(e,t)=>{fetch(`?c=Nominas&m=showConceptsFijosID&id=${e}`).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallos la consulta"))).then(e=>e.json()).then(e=>{b=[],T(b=e,t),"update"==t&&(document.getElementById("update_nomina").value=`${e[0].id_nomina}`)}).catch(e=>console.log(e))}}
// ! end JS Modulo Administrar Usuarios