import{msgError,msgSuccess}from"../message.js";import{liMostrar,TableAndpagination,pagina}from"../pagination.js";import{toolbarOptions}from"../main.js";if("?c=Noticias&m=showNews"==location.search){let e=[];const t=document.getElementById("tablaAllNews");t.addEventListener("click",t=>{const a=t.target;if(a.getAttribute("id")){const t=a.getAttribute("id"),n=e.filter(e=>e.id_noticia==t)[0];if("#ModalUpdateNews"==a.getAttribute("data-target"))o(n);else if("#ModalDeleteNews"==a.getAttribute("data-target")){const e=`${n.titulo_noticia} del autor ${n.nombres} ${n.apellidos}`;E(e,n.id_noticia)}else"#ModalShowNews"==a.getAttribute("data-target")&&c(n)}});const a=(e,t)=>{const a=document.createDocumentFragment(),n=document.createElement("TR");n.classList.add("table-light");const i=document.createElement("TD");i.setAttribute("colspan","1"),i.textContent=`${t}`,n.append(i);const o=document.createElement("TD");o.setAttribute("colspan","2"),o.textContent=`${e.titulo_noticia}`,o.classList.add("text-capitalize"),n.append(o);const c=document.createElement("TD");c.setAttribute("colspan","2"),c.textContent=`${e.fecha_publicado}`,n.append(c);const l=document.createElement("TD");l.textContent=`${e.nombres} ${e.apellidos}`,l.classList.add("text-capitalize"),n.append(l);const r=document.createElement("TD");r.classList.add("i-separated");let d=document.createElement("I");d.id=`${e.id_noticia}`,d.setAttribute("data-toggle","modal"),d.setAttribute("data-target","#ModalShowNews"),d.classList.add("show-svg"),r.append(d);let s=document.createElement("I");s.id=`${e.id_noticia}`,s.classList.add("edit-svg"),s.setAttribute("data-toggle","modal"),s.setAttribute("data-target","#ModalUpdateNews"),r.append(s);let u=document.createElement("I");return u.id=`${e.id_noticia}`,u.classList.add("delete-svg"),u.setAttribute("data-target","#ModalDeleteNews"),r.append(u),n.append(r),a.append(n),a},n=e=>{const n=document.createDocumentFragment();let i=0;for(const t of e)i++,n.append(a(t,i));t.innerHTML="",t.append(n)};liMostrar.addEventListener("click",function(t){if("button"==t.target.localName)if("Siguiente"!=t.target.textContent&&"Anterior"!=t.target.textContent){let a=t.target.textContent;pagina.pagina=Number(a),TableAndpagination(pagina.pagina,pagina.usuariosFila,e,n)}else if("Siguiente"==t.target.textContent){let t=Math.ceil(e.length/pagina.usuariosFila);pagina.pagina<t&&(pagina.pagina+=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,n))}else"Anterior"==t.target.textContent&&pagina.pagina>1&&(pagina.pagina-=1,TableAndpagination(pagina.pagina,pagina.usuariosFila,e,n))});const i=()=>{fetch("?c=Noticias&m=allNewsJson").then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallo la consulta News"))).then(e=>e.json()).then(t=>{e=t,TableAndpagination(pagina.pagina,pagina.usuariosFila,t,n)}).catch(console.log)},o=e=>{document.getElementById("update_titulo_noticia").value=`${e.titulo_noticia}`,quillUpdate.clipboard.dangerouslyPasteHTML(`${e.descripcion_noticia}`),document.getElementById("update_fk_usuario").value=`${e.fk_usuario}`,document.getElementById("update_prev-img").src=`${e.imagen_noticia}`,document.getElementById("update_id_noticia").value=`${e.id_noticia}`},c=e=>{document.getElementById("show_titulo_noticia").textContent=`${e.titulo_noticia}`,document.getElementById("show_descripcion_noticia").innerHTML=`${e.descripcion_noticia}`,document.getElementById("show_fecha_noticia").textContent=`${e.nombres} ${e.apellidos} ${e.fecha_publicado}`,document.getElementById("show_prev_img").src=`${e.imagen_noticia}`},l=document.getElementById("buscador");l.addEventListener("input",function(i){let o=l.value.toLowerCase();if(t.innerHTML="",""!=o.trim()){let n=1;for(const i of e)-1!=`${i.titulo_noticia}`.indexOf(o)&&t.appendChild(a(i,n++))}""==o.trim()&&TableAndpagination(pagina.pagina,pagina.usuariosFila,e,n)});const r=document.getElementById("new_img"),d=document.getElementById("prev-img"),s=document.getElementById("update_new_img"),u=document.getElementById("update_prev-img"),m=(e,t)=>{const a=e.files[0];if("image/jpeg"!=a.type&&"image/png"!=a.type&&"image/jpeg"!=a.type)return e.value="",msgError("la imagen debe ser png o jpeg"),t.src="",t.alt="image not found",!1;if(a.size>2e6)return e.value="",msgError("la imagen debe ser menor a 2mb"),t.src="",t.alt="image not found",!1;{t.src="";const e=new FileReader;return e.readAsDataURL(a),e.addEventListener("load",e=>{t.src=e.target.result}),!0}};r.addEventListener("change",()=>{m(r,d)}),s.addEventListener("change",()=>{m(s,u)});const g=(e,t,a,n)=>{if(""==e.value){const t="Ingrese el titulo de la Noticia";e.focus(),msgError(t)}else if(t.getLength()-1==0){const e="Ingrese la descripcion de la Noticia";t.focus(),msgError(e)}else if(""==a.value){const e="Ingrese el autor de la Noticia";a.focus(),msgError(e)}else{if(""!=n.src&&"image not found"!=n.alt)return!0;{const e="Ingrese la imagen de la Noticia";n.focus(),msgError(e)}}},p=(e,t,a,n,i)=>{document.getElementById(e).value="",t.container.firstChild.innerHTML="",document.getElementById(a).value="",document.getElementById(n).value="",document.getElementById(i).src=""};document.getElementById("GuardarNoticia").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("titulo_noticia"),a=quill,n=document.getElementById("fk_usuario"),o=r.files[0];if(!0===g(t,a,n,d)){const e=new FormData;e.append("titulo_noticia",t.value.toLowerCase()),e.append("descripcion_noticia",a.container.firstChild.innerHTML),e.append("new_img",o),e.append("fk_usuario",n.value),fetch("?c=Noticias&m=storeNew",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Fallo la insercion"))).then(e=>e.json()).then(e=>{e.ok?($("#ModalAddNew").modal("hide"),p("titulo_noticia",a,"fk_usuario","new_img","prev-img"),msgSuccess("Noticia Agregada Correctamente"),i()):msgError("Error ha modificado el html")}).catch(console.log)}});const _=document.getElementById("CancelarNoticia"),f=document.getElementById("cerrarModalNoticia");_.addEventListener("click",()=>{p("titulo_noticia",quill,"fk_usuario","new_img","prev-img")}),f.addEventListener("click",()=>{p("titulo_noticia",quill,"fk_usuario","new_img","prev-img")}),document.getElementById("ActualizarNoticia").addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("update_titulo_noticia"),a=quillUpdate,n=document.getElementById("update_fk_usuario"),o=document.getElementById("update_id_noticia"),c=s.files[0];if(1==g(t,a,n,u)){const e=new FormData;e.append("update_id_noticia",o.value),e.append("update_titulo_noticia",t.value.toLowerCase()),e.append("update_descripcion_noticia",a.container.firstChild.innerHTML),e.append("update_fk_usuario",n.value),e.append("update_new_img",c),fetch("?c=Noticias&m=updateNews",{method:"POST",body:e}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("Error al actualizar noticia"))).then(e=>e.json()).then(e=>{e.ok?($("#ModalUpdateNews").modal("hide"),msgSuccess("La noticia se ha actualizado correctamente"),i()):(msgError("Error ha modificado el html"),setTimeout(()=>{location="?c=All&m=index"},1500))}).catch(console.log)}});const E=(e,t)=>{Swal.fire({icon:"warning",html:`<p class="text-white h4 mb-3 text-capitalize">Desea borrar la noticia</p><p class="text-danger text-capitalize h6">${e}</p>`,focusConfirm:!0,background:"#343a40",confirmButtonText:"Entendido",confirmButtonColor:"#6C63FF",showCancelButton:!0,cancelButtonText:"Cancelar",cancelButtonColor:"#6C63FF"}).then(e=>{e.value&&(msgSuccess("El usuarios ha sido eliminado"),h(t))})},h=e=>{fetch(`?c=Noticias&m=destroyNew&id=${e}`,{}).then(e=>e.ok?Promise.resolve(e):Promise.reject(new Error("fallo el delete"))).then(e=>e.text()).then(e=>{i()}).catch(console.log)};i();var quill=new Quill("#descripcion_noticia",{modules:{toolbar:toolbarOptions},theme:"snow"}),quillUpdate=new Quill("#update_descripcion_noticia",{modules:{toolbar:toolbarOptions},theme:"snow"})}